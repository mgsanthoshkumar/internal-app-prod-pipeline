name: CI/CD Pipeline - Build and Deploy

on:
  push:
    branches:
      - master # Triggers pipeline on push to the master branch

env:
  REGISTRY: ghcr.io # GitHub Container Registry
  IMAGE_NAME: ${{ github.repository }} # Resolves to your repo path

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to the Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # Uses the token with Read/Write permission

      - name: Build and Push Docker image (Inline Fix)
        # Uses inline shell commands to build and push the image
        run: |
          # 1. Define the unique image tag
          IMAGE_TAG_SHA="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          
          # 2. Build the Docker image
          docker build -t $IMAGE_TAG_SHA .
          
          # 3. Push the unique tag
          echo "Pushing versioned image: $IMAGE_TAG_SHA"
          docker push $IMAGE_TAG_SHA
          
          # 4. Tag and push 'latest'
          IMAGE_TAG_LATEST="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          docker tag $IMAGE_TAG_SHA $IMAGE_TAG_LATEST
          echo "Pushing latest image: $IMAGE_TAG_LATEST"
          docker push $IMAGE_TAG_LATEST

  deploy_staging:
    needs: build_and_push # Only runs if the image build job succeeds
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Kubeconfig for Staging
        # Writes the portable Kubeconfig secret (with embedded certs) to a file
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" > $HOME/kubeconfig.yaml

      - name: Deploy to Staging Cluster
        # Uses a dedicated action to simplify the kubectl application
        uses: alexellis/k8s-action@master
        with:
          kubeconfig: $HOME/kubeconfig.yaml
          yaml: app-manifest.yaml
          namespace: staging # Deploys to the dedicated 'staging' namespace
